//
// my_lcd_scan.c
//

typedef enum MyLcdControlMode {
  MyLcdControlMode_rotate_image = 0,
} MyLcdControlMode;

typedef struct MyLcdControl {
	MyLcdControlMode mode;
	uint8_t          amount;
	uint16_t         index;
} MyLcdControl;

#define MY_LCD_FONT_WIDTH 5
#define MY_LCD_FONT_HGAP  1

uint8_t my_font5x7[95][MY_LCD_FONT_WIDTH] = {
  { 0x00, 0x00, 0x00, 0x00, 0x00 }, // space
  { 0x00, 0x00, 0x00, 0xfa, 0x00 }, // !
  { 0x00, 0xc0, 0x00, 0xc0, 0x00 }, // "
  { 0x28, 0x7c, 0x28, 0x7c, 0x28 }, // #
  { 0x64, 0x92, 0xfe, 0x92, 0x4c }, // $
  { 0xc6, 0xc8, 0x10, 0x26, 0xc6 }, // %
  { 0x6c, 0x92, 0xaa, 0x44, 0x0a }, // &
  { 0x00, 0x00, 0xc0, 0x00, 0x00 }, // '
  { 0x00, 0x00, 0x7c, 0x82, 0x00 }, // (
  { 0x00, 0x82, 0x7c, 0x00, 0x00 }, // )
  { 0x44, 0x28, 0xfe, 0x28, 0x44 }, // *
  { 0x10, 0x10, 0x7c, 0x10, 0x10 }, // +
  { 0x00, 0x02, 0x06, 0x00, 0x00 }, // ,
  { 0x00, 0x10, 0x10, 0x10, 0x00 }, // -
  { 0x00, 0x00, 0x02, 0x00, 0x00 }, // .
  { 0x06, 0x08, 0x10, 0x20, 0xc0 }, // /
  { 0x7c, 0x82, 0x82, 0x82, 0x7c }, // 0
  { 0x42, 0x42, 0xfe, 0x02, 0x02 }, // 1
  { 0x42, 0x86, 0x8a, 0x92, 0x62 }, // 2
  { 0x44, 0x82, 0x92, 0x92, 0x6c }, // 3
  { 0x08, 0x18, 0x28, 0x48, 0xfe }, // 4
  { 0xf4, 0x92, 0x92, 0x92, 0x8c }, // 5
  { 0x7c, 0x92, 0x92, 0x92, 0x4c }, // 6
  { 0x80, 0x8e, 0x90, 0xa0, 0xc0 }, // 7
  { 0x6c, 0x92, 0x92, 0x92, 0x6c }, // 8
  { 0x64, 0x92, 0x92, 0x92, 0x7c }, // 9
  { 0x00, 0x00, 0x12, 0x00, 0x00 }, // :
  { 0x00, 0x02, 0x16, 0x00, 0x00 }, // ;
  { 0x00, 0x10, 0x28, 0x44, 0x82 }, // <
  { 0x28, 0x28, 0x28, 0x28, 0x28 }, // =
  { 0x00, 0x82, 0x44, 0x28, 0x10 }, // >
  { 0x40, 0x8a, 0x90, 0x90, 0x60 }, // ?
  { 0x7c, 0x82, 0x98, 0xa4, 0x78 }, // @
  { 0x7e, 0x90, 0x90, 0x90, 0x7e }, // A
  { 0xfe, 0x92, 0x92, 0x92, 0x6c }, // B
  { 0x7c, 0x82, 0x82, 0x82, 0x44 }, // C
  { 0xfe, 0x82, 0x82, 0x82, 0x7c }, // D
  { 0xfe, 0x92, 0x92, 0x92, 0x82 }, // E
  { 0xfe, 0x90, 0x90, 0x90, 0x80 }, // F
  { 0x7c, 0x82, 0x92, 0x92, 0x5e }, // G
  { 0xfe, 0x10, 0x10, 0x10, 0xfe }, // H
  { 0x02, 0x82, 0xfe, 0x82, 0x02 }, // I
  { 0x04, 0x82, 0x82, 0x82, 0xfc }, // J
  { 0xfe, 0x10, 0x28, 0x44, 0x82 }, // K
  { 0xfe, 0x02, 0x02, 0x02, 0x02 }, // L
  { 0xfe, 0x80, 0x70, 0x80, 0xfe }, // M
  { 0xfe, 0x20, 0x10, 0x08, 0xfe }, // N
  { 0x7c, 0x82, 0x82, 0x82, 0x7c }, // O
  { 0xfe, 0x90, 0x90, 0x90, 0x60 }, // P
  { 0x7c, 0x82, 0x8a, 0x84, 0x7a }, // Q
  { 0xfe, 0x90, 0x98, 0x94, 0x62 }, // R
  { 0x64, 0x92, 0x92, 0x92, 0x4c }, // S
  { 0x80, 0x80, 0xfe, 0x80, 0x80 }, // T
  { 0xfc, 0x02, 0x02, 0x02, 0xfc }, // U
  { 0xf8, 0x04, 0x02, 0x04, 0xf8 }, // V
  { 0xfc, 0x02, 0x3c, 0x02, 0xfc }, // W
  { 0x82, 0x44, 0x38, 0x44, 0x82 }, // X
  { 0xe0, 0x10, 0x0e, 0x10, 0xe0 }, // Y
  { 0x86, 0x8a, 0x92, 0xa2, 0xc2 }, // Z
  { 0x00, 0x00, 0xfe, 0x82, 0x00 }, // [
  { 0xc0, 0x20, 0x10, 0x08, 0x06 }, // backslash
  { 0x00, 0x82, 0xfe, 0x00, 0x00 }, // ]
  { 0x20, 0x40, 0x80, 0x40, 0x20 }, // ^
  { 0x02, 0x02, 0x02, 0x02, 0x02 }, // _
  { 0x00, 0x80, 0x40, 0x00, 0x00 }, // `
  { 0x00, 0x0c, 0x52, 0x52, 0x3c }, // a
  { 0x00, 0xfc, 0x22, 0x22, 0x1c }, // b
  { 0x00, 0x3c, 0x42, 0x42, 0x24 }, // c
  { 0x00, 0x1c, 0x22, 0x22, 0xfc }, // d
  { 0x00, 0x3c, 0x4a, 0x4a, 0x38 }, // e
  { 0x00, 0x7e, 0x90, 0x80, 0x00 }, // f
  { 0x00, 0x30, 0x4a, 0x4a, 0x3c }, // g
  { 0x00, 0xfe, 0x20, 0x20, 0x1e }, // h
  { 0x00, 0x00, 0x20, 0xbc, 0x02 }, // i
  { 0x00, 0x04, 0x02, 0x22, 0xbc }, // j
  { 0x00, 0xfe, 0x08, 0x14, 0x22 }, // k
  { 0x00, 0x00, 0x80, 0xfc, 0x02 }, // l
  { 0x3e, 0x40, 0x3e, 0x40, 0x3e }, // m
  { 0x00, 0x3e, 0x40, 0x40, 0x3e }, // n
  { 0x00, 0x3c, 0x42, 0x42, 0x3c }, // o
  { 0x00, 0x3e, 0x48, 0x48, 0x30 }, // p
  { 0x00, 0x30, 0x48, 0x48, 0x3e }, // q
  { 0x00, 0x00, 0x3e, 0x40, 0x40 }, // r
  { 0x00, 0x24, 0x52, 0x4a, 0x24 }, // s
  { 0x00, 0x00, 0x7c, 0x22, 0x22 }, // t
  { 0x00, 0x7c, 0x02, 0x02, 0x7c }, // u
  { 0x00, 0x78, 0x04, 0x02, 0x7c }, // v
  { 0x7c, 0x02, 0x3c, 0x02, 0x7c }, // w
  { 0x42, 0x24, 0x18, 0x24, 0x42 }, // x
  { 0x00, 0x70, 0x0a, 0x0a, 0x7c }, // y
  { 0x00, 0x46, 0x4a, 0x52, 0x62 }, // z
  { 0x00, 0x10, 0xee, 0x82, 0x00 }, // {
  { 0x00, 0x00, 0xfe, 0x00, 0x00 }, // |
  { 0x00, 0x82, 0xee, 0x10, 0x00 }, // }
  { 0x10, 0x20, 0x10, 0x08, 0x10 }  // ~
};

//------------------------------------------------------------------------------
// Function: my_LCD_set_char
//
// c:   ASCII character between ' ' (space) and '~'
// col: 1 to LCD_PAGE_LEN / ( MY_LCD_FONT_WIDTH + MY_LCD_FONT_HGAP )
// row: 1 to LCD_TOTAL_VISIBLE_PAGES
//
//     |---> col
// ----+--------------------------------+
//  |  |     |                          |
//  v  |     |                          |
// row |---- c                          |
//     |                                |
//     +--------------------------------+
//------------------------------------------------------------------------------

void my_LCD_set_char( char c, uint8_t row, uint8_t col ) {
  uint8_t page_idx;
  uint8_t char_idx;

  if ( c < ' ' || c > '~' ) return;
  if ( row < 1 || row > LCD_PAGE_LEN ) return;
  if ( col < 1 || col > LCD_PAGE_LEN / ( MY_LCD_FONT_WIDTH + MY_LCD_FONT_HGAP ) ) return;

  char_idx = c - 0x20; // ASCII space is 0x20
  page_idx = LCD_TOTAL_VISIBLE_PAGES - row;
  for ( uint8_t p = 0; p < MY_LCD_FONT_WIDTH; p++ ) { // p: pixel
    uint16_t pixel_idx = LCD_PAGE_LEN * page_idx + ( MY_LCD_FONT_WIDTH + MY_LCD_FONT_HGAP ) * ( col - 1 ) + p;

    STLcdImage3[ pixel_idx ] = my_font5x7[ char_idx ][ p ];
  }
} // my_LCD_set_char

//------------------------------------------------------------------------------
// Function: my_LCD_set_str
//
// s:   ASCII string (it does not wrap around)
// col: 1 to LCD_PAGE_LEN / ( MY_LCD_FONT_WIDTH + MY_LCD_FONT_HGAP )
// row: 1 to LCD_TOTAL_VISIBLE_PAGES
//
//     |---> col
// ----+--------------------------------+
//  |  |     |                          |
//  v  |     |                          |
// row |---- sss                        |
//     |                                |
//     +--------------------------------+
//------------------------------------------------------------------------------

void my_LCD_set_str( char* s, uint8_t row, uint8_t col ) {
  uint8_t i;

  i = 0;
  while ( s[i] ) {
    my_LCD_set_char( s[i], row, col + i );
    i++;
  }
} // my_LCD_set_str

//------------------------------------------------------------------------------
// Function: my_LCD_display
//------------------------------------------------------------------------------

void my_LCD_display( MyLcdControl* control ) {
  switch ( control->mode ) {
  case MyLcdControlMode_rotate_image:
    image_idx += control->amount;
    if ( image_idx > 3 ) image_idx = 0;
    for ( uint8_t page = 0; page < LCD_TOTAL_VISIBLE_PAGES; page++ ) {
      switch ( image_idx ) {
      case 0: LCD_writeDisplayReg( page, (uint8_t*)&STLcdDefaultImage[ page * LCD_PAGE_LEN ], LCD_PAGE_LEN ); break;
      case 1: LCD_writeDisplayReg( page, (uint8_t*)&STLcdImage1      [ page * LCD_PAGE_LEN ], LCD_PAGE_LEN ); break;
      case 2: LCD_writeDisplayReg( page, (uint8_t*)&STLcdImage2      [ page * LCD_PAGE_LEN ], LCD_PAGE_LEN ); break;
      case 3: 
	my_LCD_set_str( "Special Characters:", 1, 1 );
	my_LCD_set_str( "!\"#$%&'()*+,-./",    2, 1 );
	my_LCD_set_str( ":;<=>?@",             3, 1 );
	my_LCD_set_str( "[\\]^_`{|}~",         4, 1 );
	LCD_writeDisplayReg( page, (uint8_t*)&STLcdImage3[ page * LCD_PAGE_LEN ], LCD_PAGE_LEN ); 
	break;
      }
    }
  }
} // my_LCD_display

//------------------------------------------------------------------------------
// Function: my_LCD_display_capability
//------------------------------------------------------------------------------

void my_LCD_display_capability( uint8_t state, uint8_t stateType, uint8_t *args ) {
  if ( stateType == 0xFF && state == 0xFF ) return;
  if ( stateType == 0x00 && state == 0x02 ) return; // on hold
  if ( stateType == 0x00 && state == 0x03 ) return; // on release

  MyLcdControl* control = ( MyLcdControl* ) args;

  my_LCD_display( control );
} // my_LCD_display_capability
